# Dockerfile для генерации конфигурации

# Этап 1: Получаем xray binary из официального образа
FROM teddysun/xray:26.1.18 AS xray-source

# Этап 2: Создаем рабочий образ с утилитами
FROM alpine:3.19

# Установка всех необходимых утилит для генерации конфигов
RUN apk add --no-cache \
    bash \
    curl \
    jq \
    openssl \
    sed \
    grep \
    coreutils \
    libqrencode \
    libpng \
    libpng-dev \
    build-base \
    autoconf \
    automake \
    libtool \
    pkgconfig \
    git

# --- собираем qrencode CLI ---
RUN git clone https://github.com/fukuchi/libqrencode.git /tmp/libqrencode \
    && cd /tmp/libqrencode \
    && ./autogen.sh \
    && ./configure \
    && make \
    && make install \
    && cd / \
    && rm -rf /tmp/libqrencode

# Копируем xray binary из официального образа (только для генерации ключей и UUID)
COPY --from=xray-source /usr/bin/xray /usr/local/bin/xray

# Делаем xray исполняемым
RUN chmod +x /usr/local/bin/xray

# Устанавливаем рабочую директорию
WORKDIR /app

# Копируем скрипты генерации
COPY . .

CMD ["/bin/bash", "-c", "./install.sh"]
